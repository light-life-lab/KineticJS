(function(){Kinetic.Image=function(e){this._initImage(e)},Kinetic.Image.prototype={_initImage:function(e){Kinetic.Shape.call(this,e),this.shapeType="Image",this._setDrawFuncs();var t=this;this.on("imageChange",function(e){t._syncSize()}),this._syncSize()},drawFunc:function(e){var t=this.getWidth(),n=this.getHeight(),r,i=this,s=e.getContext();s.beginPath(),s.rect(0,0,t,n),s.closePath(),e.fillStroke(this);if(this.attrs.image){if(this.attrs.crop&&this.attrs.crop.width&&this.attrs.crop.height){var o=this.attrs.crop.x||0,u=this.attrs.crop.y||0,a=this.attrs.crop.width,f=this.attrs.crop.height;r=[this.attrs.image,o,u,a,f,0,0,t,n]}else r=[this.attrs.image,0,0,t,n];this.hasShadow()?e.applyShadow(this,function(){i._drawImage(s,r)}):this._drawImage(s,r)}},drawHitFunc:function(e){var t=this.getWidth(),n=this.getHeight(),r=this.imageHitRegion,i=!1,s=e.getContext();r?(s.drawImage(r,0,0,t,n),s.beginPath(),s.rect(0,0,t,n),s.closePath(),e.stroke(this)):(s.beginPath(),s.rect(0,0,t,n),s.closePath(),e.fillStroke(this))},applyFilter:function(e,t,n){var r=new Kinetic.Canvas(this.attrs.image.width,this.attrs.image.height),i=r.getContext();i.drawImage(this.attrs.image,0,0);try{var s=i.getImageData(0,0,r.getWidth(),r.getHeight());e(s,t);var o=this;Kinetic.Type._getImage(s,function(e){o.setImage(e),n&&n()})}catch(u){Kinetic.Global.warn("Unable to apply filter. "+u.message)}},setCrop:function(){var e=[].slice.call(arguments),t=Kinetic.Type._getXY(e),n=Kinetic.Type._getSize(e),r=Kinetic.Type._merge(t,n);this.setAttr("crop",Kinetic.Type._merge(r,this.getCrop()))},createImageHitRegion:function(e){var t=new Kinetic.Canvas(this.attrs.width,this.attrs.height),n=t.getContext();n.drawImage(this.attrs.image,0,0);try{var r=n.getImageData(0,0,t.getWidth(),t.getHeight()),i=r.data,s=Kinetic.Type._hexToRgb(this.colorKey);for(var o=0,u=i.length;o<u;o+=4)i[o]=s.r,i[o+1]=s.g,i[o+2]=s.b;var a=this;Kinetic.Type._getImage(r,function(t){a.imageHitRegion=t,e&&e()})}catch(f){Kinetic.Global.warn("Unable to create image hit region. "+f.message)}},clearImageHitRegion:function(){delete this.imageHitRegion},_syncSize:function(){this.attrs.image&&(this.attrs.width||this.setWidth(this.attrs.image.width),this.attrs.height||this.setHeight(this.attrs.image.height))},_drawImage:function(e,t){t.length===5?e.drawImage(t[0],t[1],t[2],t[3],t[4]):t.length===9&&e.drawImage(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])}},Kinetic.Global.extend(Kinetic.Image,Kinetic.Shape),Kinetic.Node.addGettersSetters(Kinetic.Image,["image"]),Kinetic.Node.addGetters(Kinetic.Image,["crop"])})();
