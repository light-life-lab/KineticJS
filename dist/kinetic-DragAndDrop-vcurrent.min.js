(function(){Kinetic.DD={anim:new Kinetic.Animation,moving:!1,offset:{x:0,y:0}},Kinetic.DD._setupDragLayerAndGetContainer=function(e){var t=Kinetic.DD,n=e.getStage(),r=e.nodeType,i,s;return e._eachAncestorReverse(function(e){e.nodeType==="Layer"?(n.dragLayer.setAttrs({x:e.getX(),y:e.getY(),scale:e.getScale(),rotation:e.getRotation()}),i=n.dragLayer,n.add(n.dragLayer)):e.nodeType==="Group"&&(s=new Kinetic.Group({x:e.getX(),y:e.getY(),scale:e.getScale(),rotation:e.getRotation()}),i.add(s),i=s)}),i},Kinetic.DD._initDragLayer=function(e){e.dragLayer=new Kinetic.Layer,e.dragLayer.getCanvas().getElement().className="kinetic-drag-and-drop-layer"},Kinetic.DD._drag=function(e){var t=Kinetic.DD,n=t.node;if(n){var r=n.getStage().getUserPosition(),i=n.attrs.dragBoundFunc,s={x:r.x-t.offset.x,y:r.y-t.offset.y};i!==undefined&&(s=i.call(n,s,e)),n.setAbsolutePosition(s),t.moving||(t.moving=!0,n.setListening(!1),n._handleEvent("dragstart",e)),n._handleEvent("dragmove",e)}},Kinetic.DD._endDrag=function(e){var t=Kinetic.DD,n=t.node,r,i;n&&(r=n.nodeType,i=n.getStage(),n.setListening(!0),r==="Stage"?n.draw():((r==="Group"||r==="Shape")&&n.getDragOnTop()&&t.prevParent&&(n.moveTo(t.prevParent),n.getStage().dragLayer.remove(),t.prevParent=null),n.getLayer().draw()),t.moving&&(t.moving=!1,n._handleEvent("dragend",e))),delete t.node,t.anim.stop()},Kinetic.Node.prototype._startDrag=function(){var e=this,t=Kinetic.DD,n=this.getStage(),r=n.getUserPosition();if(r){var i=this.getTransform().getTranslation(),s=this.getAbsolutePosition(),o=this.nodeType,u;t.node=this,t.offset.x=r.x-s.x,t.offset.y=r.y-s.y,o==="Stage"||o==="Layer"?(t.anim.node=this,t.anim.start()):this.getDragOnTop()?(u=t._setupDragLayerAndGetContainer(this),t.anim.node=n.dragLayer,t.prevParent=this.getParent(),setTimeout(function(){t.node&&(e.moveTo(u),t.prevParent.getLayer().draw(),n.dragLayer.draw(),t.anim.start())},0)):(t.anim.node=this.getLayer(),t.anim.start())}},Kinetic.Node.prototype.setDraggable=function(e){this.setAttr("draggable",e),this._dragChange()},Kinetic.Node.prototype.getDraggable=function(){return this.attrs.draggable},Kinetic.Node.prototype.isDragging=function(){var e=Kinetic.DD;return e.node&&e.node._id===this._id&&e.moving},Kinetic.Node.prototype._listenDrag=function(){this._dragCleanup(),this.on("mousedown.kinetic touchstart.kinetic",this._startDrag)},Kinetic.Node.prototype._dragChange=function(){if(this.attrs.draggable)this._listenDrag();else{this._dragCleanup();var e=this.getStage(),t=Kinetic.DD;e&&t.node&&t.node._id===this._id&&t._endDrag()}},Kinetic.Node.prototype._dragCleanup=function(){this.off("mousedown.kinetic"),this.off("touchstart.kinetic")},Kinetic.Node.prototype.isDraggable=Kinetic.Node.prototype.getDraggable,Kinetic.Node.addGettersSetters(Kinetic.Node,["dragBoundFunc","dragOnTop"])})();
