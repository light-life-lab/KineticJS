(function(){Kinetic.Canvas=function(e,t){this.width=e,this.height=t,this.element=document.createElement("canvas"),this.context=this.element.getContext("2d"),this.setSize(e||0,t||0)};var e=document.createElement("canvas"),t=e.getContext("2d"),n=window.devicePixelRatio||1,r=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;Kinetic.Canvas.pixelRatio=n/r,Kinetic.Canvas.prototype={clear:function(){var e=this.getContext(),t=this.getElement();e.clearRect(0,0,t.width,t.height)},getElement:function(){return this.element},getContext:function(){return this.context},setWidth:function(e){this.width=e,this.element.width=e*Kinetic.Canvas.pixelRatio,this.element.style.width=e+"px"},setHeight:function(e){this.height=e,this.element.height=e*Kinetic.Canvas.pixelRatio,this.element.style.height=e+"px"},getWidth:function(){return this.width},getHeight:function(){return this.height},setSize:function(e,t){this.setWidth(e),this.setHeight(t)},toDataURL:function(e,t){try{return this.element.toDataURL(e,t)}catch(n){try{return this.element.toDataURL()}catch(n){return Kinetic.Global.warn("Unable to get data URL. "+n.message),""}}},fill:function(e){e.getFillEnabled()&&this._fill(e)},stroke:function(e){e.getStrokeEnabled()&&this._stroke(e)},fillStroke:function(e){var t=e.getFillEnabled();t&&this._fill(e),e.getStrokeEnabled()&&this._stroke(e,e.hasShadow()&&e.hasFill()&&t)},applyShadow:function(e,t){var n=this.context;n.save(),this._applyShadow(e),t(),n.restore(),t()},_applyLineCap:function(e){var t=e.getLineCap();t&&(this.context.lineCap=t)},_applyOpacity:function(e){var t=e.getAbsoluteOpacity();t!==1&&(this.context.globalAlpha=t)},_applyLineJoin:function(e){var t=e.getLineJoin();t&&(this.context.lineJoin=t)},_handlePixelRatio:function(){var e=Kinetic.Canvas.pixelRatio;e!==1&&this.getContext().scale(e,e)},_counterPixelRatio:function(){var e=Kinetic.Canvas.pixelRatio;e!==1&&(e=1/e,this.getContext().scale(e,e))},_applyAncestorTransforms:function(e){var t=this.context;e._eachAncestorReverse(function(e){var n=e.getTransform(),r=n.getMatrix();t.transform(r[0],r[1],r[2],r[3],r[4],r[5])},!0)}},Kinetic.SceneCanvas=function(e,t){Kinetic.Canvas.call(this,e,t)},Kinetic.SceneCanvas.prototype={_fillColor:function(e){var t=this.context,n=e.getFill();t.fillStyle=n,e._fillFunc(t)},_fillPattern:function(e){var t=this.context,n=e.getFillPatternImage(),r=e.getFillPatternX(),i=e.getFillPatternY(),s=e.getFillPatternScale(),o=e.getFillPatternRotation(),u=e.getFillPatternOffset(),a=e.getFillPatternRepeat();(r||i)&&t.translate(r||0,i||0),o&&t.rotate(o),s&&t.scale(s.x,s.y),u&&t.translate(-1*u.x,-1*u.y),t.fillStyle=t.createPattern(n,a||"repeat"),t.fill()},_fillLinearGradient:function(e){var t=this.context,n=e.getFillLinearGradientStartPoint(),r=e.getFillLinearGradientEndPoint(),i=e.getFillLinearGradientColorStops(),s=t.createLinearGradient(n.x,n.y,r.x,r.y);for(var o=0;o<i.length;o+=2)s.addColorStop(i[o],i[o+1]);t.fillStyle=s,t.fill()},_fillRadialGradient:function(e){var t=this.context,n=e.getFillRadialGradientStartPoint(),r=e.getFillRadialGradientEndPoint(),i=e.getFillRadialGradientStartRadius(),s=e.getFillRadialGradientEndRadius(),o=e.getFillRadialGradientColorStops(),u=t.createRadialGradient(n.x,n.y,i,r.x,r.y,s);for(var a=0;a<o.length;a+=2)u.addColorStop(o[a],o[a+1]);t.fillStyle=u,t.fill()},_fill:function(e,t){var n=this.context,r=e.getFill(),i=e.getFillPatternImage(),s=e.getFillLinearGradientStartPoint(),o=e.getFillRadialGradientStartPoint();n.save(),!t&&e.hasShadow()&&this._applyShadow(e),r?this._fillColor(e):i?this._fillPattern(e):s?this._fillLinearGradient(e):o&&this._fillRadialGradient(e),n.restore(),!t&&e.hasShadow()&&this._fill(e,!0)},_stroke:function(e,t){var n=this.context,r=e.getStroke(),i=e.getStrokeWidth(),s=e.getDashArray();if(r||i)n.save(),this._applyLineCap(e),s&&e.getDashArrayEnabled()&&n.setLineDash&&n.setLineDash(s),!t&&e.hasShadow()&&this._applyShadow(e),n.lineWidth=i||2,n.strokeStyle=r||"black",e._strokeFunc(n),n.restore(),!t&&e.hasShadow()&&this._stroke(e,!0)},_applyShadow:function(e){var t=this.context;if(e.hasShadow()&&e.getShadowEnabled()){var n=e.getAbsoluteOpacity(),r=e.getShadowColor()||"black",i=e.getShadowBlur()||5,s=e.getShadowOffset()||{x:0,y:0};e.getShadowOpacity()&&(t.globalAlpha=e.getShadowOpacity()*n),t.shadowColor=r,t.shadowBlur=i,t.shadowOffsetX=s.x,t.shadowOffsetY=s.y}}},Kinetic.Global.extend(Kinetic.SceneCanvas,Kinetic.Canvas),Kinetic.HitCanvas=function(e,t){Kinetic.Canvas.call(this,e,t)},Kinetic.HitCanvas.prototype={_fill:function(e){var t=this.context;t.save(),t.fillStyle="#"+e.colorKey,e._fillFunc(t),t.restore()},_stroke:function(e){var t=this.context,n=e.getStroke(),r=e.getStrokeWidth();if(n||r)this._applyLineCap(e),t.save(),t.lineWidth=r||2,t.strokeStyle="#"+e.colorKey,e._strokeFunc(t),t.restore()}},Kinetic.Global.extend(Kinetic.HitCanvas,Kinetic.Canvas)})();
