(function(){Kinetic.Node=function(e){this._nodeInit(e)},Kinetic.Node.prototype={_nodeInit:function(e){this._id=Kinetic.Global.idCounter++,this.defaultNodeAttrs={visible:!0,listening:!0,name:undefined,opacity:1,x:0,y:0,scale:{x:1,y:1},rotation:0,offset:{x:0,y:0},draggable:!1,dragOnTop:!0},this.setDefaultAttrs(this.defaultNodeAttrs),this.eventListeners={},this.setAttrs(e)},on:function(e,t){var n=e.split(" "),r=n.length;for(var i=0;i<r;i++){var s=n[i],o=s,u=o.split("."),a=u[0],f=u.length>1?u[1]:"";this.eventListeners[a]||(this.eventListeners[a]=[]),this.eventListeners[a].push({name:f,handler:t})}},off:function(e){var t=e.split(" "),n=t.length;for(var r=0;r<n;r++){var i=t[r],s=i,o=s.split("."),u=o[0];if(o.length>1)if(u)this.eventListeners[u]&&this._off(u,o[1]);else for(var i in this.eventListeners)this._off(i,o[1]);else delete this.eventListeners[u]}},remove:function(){var e=this.getParent();e&&e.children&&(e.children.splice(this.index,1),e._setChildrenIndices()),delete this.parent},destroy:function(){var e=this.getParent(),t=this.getStage(),n=Kinetic.DD,r=Kinetic.Global;while(this.children&&this.children.length>0)this.children[0].destroy();r._removeId(this.getId()),r._removeName(this.getName(),this._id),n&&n.node&&n.node._id===this._id&&node._endDrag(),this.trans&&this.trans.stop(),this.remove()},getAttrs:function(){return this.attrs},setDefaultAttrs:function(e){this.attrs===undefined&&(this.attrs={});if(e)for(var t in e)this.attrs[t]===undefined&&(this.attrs[t]=e[t])},setAttrs:function(e){if(e)for(var t in e){var n="set"+t.charAt(0).toUpperCase()+t.slice(1);Kinetic.Type._isFunction(this[n])?this[n](e[t]):this.setAttr(t,e[t])}},getVisible:function(){var e=this.attrs.visible,t=this.getParent();return e&&t&&!t.getVisible()?!1:e},getListening:function(){var e=this.attrs.listening,t=this.getParent();return e&&t&&!t.getListening()?!1:e},show:function(){this.setVisible(!0)},hide:function(){this.setVisible(!1)},getZIndex:function(){return this.index},getAbsoluteZIndex:function(){function i(t){var s=[],o=t.length;for(var u=0;u<o;u++){var a=t[u];r++,a.nodeType!=="Shape"&&(s=s.concat(a.getChildren())),a._id===n._id&&(u=o)}s.length>0&&s[0].getLevel()<=e&&i(s)}var e=this.getLevel(),t=this.getStage(),n=this,r=0;return n.nodeType!=="Stage"&&i(n.getStage().getChildren()),r},getLevel:function(){var e=0,t=this.parent;while(t)e++,t=t.parent;return e},setPosition:function(){var e=Kinetic.Type._getXY([].slice.call(arguments));this.setAttr("x",e.x),this.setAttr("y",e.y)},getPosition:function(){var e=this.attrs;return{x:e.x,y:e.y}},getAbsolutePosition:function(){var e=this.getAbsoluteTransform(),t=this.getOffset();return e.translate(t.x,t.y),e.getTranslation()},setAbsolutePosition:function(){var e=Kinetic.Type._getXY([].slice.call(arguments)),t=this._clearTransform();this.attrs.x=t.x,this.attrs.y=t.y,delete t.x,delete t.y;var n=this.getAbsoluteTransform();n.invert(),n.translate(e.x,e.y),e={x:this.attrs.x+n.getTranslation().x,y:this.attrs.y+n.getTranslation().y},this.setPosition(e.x,e.y),this._setTransform(t)},move:function(){var e=Kinetic.Type._getXY([].slice.call(arguments)),t=this.getX(),n=this.getY();e.x!==undefined&&(t+=e.x),e.y!==undefined&&(n+=e.y),this.setPosition(t,n)},_eachAncestorReverse:function(e,t){var n=[],r=this.getParent();t&&n.unshift(this);while(r)n.unshift(r),r=r.parent;var i=n.length;for(var s=0;s<i;s++)e(n[s])},rotate:function(e){this.setRotation(this.getRotation()+e)},rotateDeg:function(e){this.setRotation(this.getRotation()+Kinetic.Type._degToRad(e))},moveToTop:function(){var e=this.index;return this.parent.children.splice(e,1),this.parent.children.push(this),this.parent._setChildrenIndices(),!0},moveUp:function(){var e=this.index,t=this.parent.getChildren().length;if(e<t-1)return this.parent.children.splice(e,1),this.parent.children.splice(e+1,0,this),this.parent._setChildrenIndices(),!0},moveDown:function(){var e=this.index;if(e>0)return this.parent.children.splice(e,1),this.parent.children.splice(e-1,0,this),this.parent._setChildrenIndices(),!0},moveToBottom:function(){var e=this.index;if(e>0)return this.parent.children.splice(e,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),!0},setZIndex:function(e){var t=this.index;this.parent.children.splice(t,1),this.parent.children.splice(e,0,this),this.parent._setChildrenIndices()},getAbsoluteOpacity:function(){var e=this.getOpacity();return this.getParent()&&(e*=this.getParent().getAbsoluteOpacity()),e},moveTo:function(e){Kinetic.Node.prototype.remove.call(this),e.add(this)},toObject:function(){var e=Kinetic.Type,t={},n=this.attrs;t.attrs={};for(var r in n){var i=n[r];!e._isFunction(i)&&!e._isElement(i)&&(!e._isObject(i)||!e._hasMethods(i))&&(t.attrs[r]=i)}return t.nodeType=this.nodeType,t.shapeType=this.shapeType,t},toJSON:function(){return JSON.stringify(this.toObject())},getParent:function(){return this.parent},getLayer:function(){return this.getParent().getLayer()},getStage:function(){return this.getParent()?this.getParent().getStage():undefined},simulate:function(e,t){this._handleEvent(e,t||{})},fire:function(e,t){this._executeHandlers(e,t||{})},getAbsoluteTransform:function(){var e=new Kinetic.Transform;return this._eachAncestorReverse(function(t){var n=t.getTransform();e.multiply(n)},!0),e},getTransform:function(){var e=new Kinetic.Transform,t=this.attrs,n=t.x,r=t.y,i=t.rotation,s=t.scale,o=s.x,u=s.y,a=t.offset,f=a.x,l=a.y;return(n!==0||r!==0)&&e.translate(n,r),i!==0&&e.rotate(i),(o!==1||u!==1)&&e.scale(o,u),(f!==0||l!==0)&&e.translate(-1*f,-1*l),e},clone:function(e){var t=this.shapeType||this.nodeType,n=new Kinetic[t](this.attrs);for(var r in this.eventListeners){var i=this.eventListeners[r],s=i.length;for(var o=0;o<s;o++){var u=i[o];u.name.indexOf("kinetic")<0&&(n.eventListeners[r]||(n.eventListeners[r]=[]),n.eventListeners[r].push(u))}}return n.setAttrs(e),n},toDataURL:function(e){e=e||{};var t=e.mimeType||null,n=e.quality||null,r,i,s=e.x||0,o=e.y||0;return e.width&&e.height?r=new Kinetic.SceneCanvas(e.width,e.height):(r=this.getStage().bufferCanvas,r.clear()),i=r.getContext(),i.save(),r._counterPixelRatio(),(s||o)&&i.translate(-1*s,-1*o),this.drawScene(r),i.restore(),r.toDataURL(t,n)},toImage:function(e){Kinetic.Type._getImage(this.toDataURL(e),function(t){e.callback(t)})},setSize:function(){var e=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setWidth(e.width),this.setHeight(e.height)},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function(){return this.attrs.width||0},getHeight:function(){return this.attrs.height||0},_get:function(e){return this.nodeType===e?[this]:[]},_off:function(e,t){for(var n=0;n<this.eventListeners[e].length;n++)if(this.eventListeners[e][n].name===t){this.eventListeners[e].splice(n,1);if(this.eventListeners[e].length===0){delete this.eventListeners[e];break}n--}},_clearTransform:function(){var e=this.attrs,t=e.scale,n=e.offset,r={x:e.x,y:e.y,rotation:e.rotation,scale:{x:t.x,y:t.y},offset:{x:n.x,y:n.y}};return this.attrs.x=0,this.attrs.y=0,this.attrs.rotation=0,this.attrs.scale={x:1,y:1},this.attrs.offset={x:0,y:0},r},_setTransform:function(e){for(var t in e)this.attrs[t]=e[t]},_fireBeforeChangeEvent:function(e,t,n){this._handleEvent("before"+e.toUpperCase()+"Change",{oldVal:t,newVal:n})},_fireChangeEvent:function(e,t,n){this._handleEvent(e+"Change",{oldVal:t,newVal:n})},setId:function(e){var t=this.getId(),n=this.getStage(),r=Kinetic.Global;r._removeId(t),r._addId(this,e),this.setAttr("id",e)},setName:function(e){var t=this.getName(),n=this.getStage(),r=Kinetic.Global;r._removeName(t,this._id),r._addName(this,e),this.setAttr("name",e)},setAttr:function(e,t){if(t!==undefined){var n=this.attrs[e];this._fireBeforeChangeEvent(e,n,t),this.attrs[e]=t,this._fireChangeEvent(e,n,t)}},_handleEvent:function(e,t,n){t&&this.nodeType==="Shape"&&(t.shape=this);var r=this.getStage(),i=this.eventListeners,s=!0;e==="mouseenter"&&n&&this._id===n._id?s=!1:e==="mouseleave"&&n&&this._id===n._id&&(s=!1),s&&(i[e]&&this.fire(e,t),t&&!t.cancelBubble&&this.parent&&(n&&n.parent?this._handleEvent.call(this.parent,e,t,n.parent):this._handleEvent.call(this.parent,e,t)))},_executeHandlers:function(e,t){var n=this.eventListeners[e],r=n.length;for(var i=0;i<r;i++)n[i].handler.apply(this,[t])}},Kinetic.Node.addSetters=function(e,t){var n=t.length;for(var r=0;r<n;r++){var i=t[r];this._addSetter(e,i)}},Kinetic.Node.addPointSetters=function(e,t){var n=t.length;for(var r=0;r<n;r++){var i=t[r];this._addPointSetter(e,i)}},Kinetic.Node.addRotationSetters=function(e,t){var n=t.length;for(var r=0;r<n;r++){var i=t[r];this._addRotationSetter(e,i)}},Kinetic.Node.addGetters=function(e,t){var n=t.length;for(var r=0;r<n;r++){var i=t[r];this._addGetter(e,i)}},Kinetic.Node.addRotationGetters=function(e,t){var n=t.length;for(var r=0;r<n;r++){var i=t[r];this._addRotationGetter(e,i)}},Kinetic.Node.addGettersSetters=function(e,t){this.addSetters(e,t),this.addGetters(e,t)},Kinetic.Node.addPointGettersSetters=function(e,t){this.addPointSetters(e,t),this.addGetters(e,t)},Kinetic.Node.addRotationGettersSetters=function(e,t){this.addRotationSetters(e,t),this.addRotationGetters(e,t)},Kinetic.Node._addSetter=function(e,t){var n=this,r="set"+t.charAt(0).toUpperCase()+t.slice(1);e.prototype[r]=function(e){this.setAttr(t,e)}},Kinetic.Node._addPointSetter=function(e,t){var n=this,r="set"+t.charAt(0).toUpperCase()+t.slice(1);e.prototype[r]=function(){var e=Kinetic.Type._getXY([].slice.call(arguments));e&&e.x===undefined&&(e.x=this.attrs[t].x),e&&e.y===undefined&&(e.y=this.attrs[t].y),this.setAttr(t,e)}},Kinetic.Node._addRotationSetter=function(e,t){var n=this,r="set"+t.charAt(0).toUpperCase()+t.slice(1);e.prototype[r]=function(e){this.setAttr(t,e)},e.prototype[r+"Deg"]=function(e){this.setAttr(t,Kinetic.Type._degToRad(e))}},Kinetic.Node._addGetter=function(e,t){var n=this,r="get"+t.charAt(0).toUpperCase()+t.slice(1);e.prototype[r]=function(e){return this.attrs[t]}},Kinetic.Node._addRotationGetter=function(e,t){var n=this,r="get"+t.charAt(0).toUpperCase()+t.slice(1);e.prototype[r]=function(){return this.attrs[t]},e.prototype[r+"Deg"]=function(){return Kinetic.Type._radToDeg(this.attrs[t])}},Kinetic.Node.create=function(e,t){return this._createNode(JSON.parse(e),t)},Kinetic.Node._createNode=function(e,t){var n;e.nodeType==="Shape"?e.shapeType===undefined?n="Shape":n=e.shapeType:n=e.nodeType,t&&(e.attrs.container=t);var r=new Kinetic[n](e.attrs);if(e.children){var i=e.children.length;for(var s=0;s<i;s++)r.add(this._createNode(e.children[s]))}return r},Kinetic.Node.addGettersSetters(Kinetic.Node,["x","y","opacity"]),Kinetic.Node.addGetters(Kinetic.Node,["name","id"]),Kinetic.Node.addRotationGettersSetters(Kinetic.Node,["rotation"]),Kinetic.Node.addPointGettersSetters(Kinetic.Node,["scale","offset"]),Kinetic.Node.addSetters(Kinetic.Node,["width","height","listening","visible"]),Kinetic.Node.prototype.isListening=Kinetic.Node.prototype.getListening,Kinetic.Node.prototype.isVisible=Kinetic.Node.prototype.getVisible;var e=["on","off"];for(var t=0;t<2;t++)(function(t){var n=e[t];Kinetic.Collection.prototype[n]=function(){var e=[].slice.call(arguments);e.unshift(n),this.apply.apply(this,e)}})(t)})();
