(function(){Kinetic.Stage=function(e){this._initStage(e)},Kinetic.Stage.prototype={_initStage:function(e){var t=Kinetic.DD;this.setDefaultAttrs({width:400,height:200}),Kinetic.Container.call(this,e),this._setStageDefaultProperties(),this._id=Kinetic.Global.idCounter++,this._buildDOM(),this._bindContentEvents(),Kinetic.Global.stages.push(this),t&&t._initDragLayer(this)},setContainer:function(e){typeof e=="string"&&(e=document.getElementById(e)),this.setAttr("container",e)},setHeight:function(e){Kinetic.Node.prototype.setHeight.call(this,e),this._resizeDOM()},setWidth:function(e){Kinetic.Node.prototype.setWidth.call(this,e),this._resizeDOM()},clear:function(){var e=this.children;for(var t=0;t<e.length;t++)e[t].clear()},remove:function(){var e=this.content;Kinetic.Node.prototype.remove.call(this),e&&Kinetic.Type._isInDocument(e)&&this.attrs.container.removeChild(e)},reset:function(){this.removeChildren(),this._setStageDefaultProperties(),this.setAttrs(this.defaultNodeAttrs)},getMousePosition:function(){return this.mousePos},getTouchPosition:function(){return this.touchPos},getUserPosition:function(){return this.getTouchPosition()||this.getMousePosition()},getStage:function(){return this},getContent:function(){return this.content},toDataURL:function(e){function a(r){var i=u[r],f=i.toDataURL(),l=new Image;l.onload=function(){o.drawImage(l,0,0),r<u.length-1?a(r+1):e.callback(s.toDataURL(t,n))},l.src=f}e=e||{};var t=e.mimeType||null,n=e.quality||null,r=e.x||0,i=e.y||0,s=new Kinetic.SceneCanvas(e.width||this.getWidth(),e.height||this.getHeight()),o=s.getContext(),u=this.children;(r||i)&&o.translate(-1*r,-1*i),a(0)},toImage:function(e){var t=e.callback;e.callback=function(e){Kinetic.Type._getImage(e,function(e){t(e)})},this.toDataURL(e)},getIntersection:function(e){var t,n=this.getChildren();for(var r=n.length-1;r>=0;r--){var i=n[r];if(i.isVisible()&&i.isListening()){var s=i.hitCanvas.context.getImageData(Math.round(e.x),Math.round(e.y),1,1).data;if(s[3]===255){var o=Kinetic.Type._rgbToHex(s[0],s[1],s[2]);return t=Kinetic.Global.shapes[o],{shape:t,pixel:s}}if(s[0]>0||s[1]>0||s[2]>0||s[3]>0)return{pixel:s}}}return null},_resizeDOM:function(){if(this.content){var e=this.attrs.width,t=this.attrs.height;this.content.style.width=e+"px",this.content.style.height=t+"px",this.bufferCanvas.setSize(e,t),this.hitCanvas.setSize(e,t);var n=this.children;for(var r=0;r<n.length;r++){var i=n[r];i.getCanvas().setSize(e,t),i.hitCanvas.setSize(e,t),i.draw()}}},add:function(e){return Kinetic.Container.prototype.add.call(this,e),e.canvas.setSize(this.attrs.width,this.attrs.height),e.hitCanvas.setSize(this.attrs.width,this.attrs.height),e.draw(),this.content.appendChild(e.canvas.element),this},getDragLayer:function(){return this.dragLayer},_setUserPosition:function(e){e||(e=window.event),this._setMousePosition(e),this._setTouchPosition(e)},_bindContentEvents:function(){var e=Kinetic.Global,t=this,n=["mousedown","mousemove","mouseup","mouseout","touchstart","touchmove","touchend"];for(var r=0;r<n.length;r++){var i=n[r];(function(){var e=i;t.content.addEventListener(e,function(n){t["_"+e](n)},!1)})()}},_mouseout:function(e){this._setUserPosition(e);var t=Kinetic.DD,n=this.targetShape;n&&(!t||!t.moving)&&(n._handleEvent("mouseout",e),n._handleEvent("mouseleave",e),this.targetShape=null),this.mousePos=undefined},_mousemove:function(e){this._setUserPosition(e);var t=Kinetic.DD,n=this.getIntersection(this.getUserPosition());if(n){var r=n.shape;r&&(!!t&&!!t.moving||n.pixel[3]!==255||!!this.targetShape&&this.targetShape._id===r._id?r._handleEvent("mousemove",e):(this.targetShape&&(this.targetShape._handleEvent("mouseout",e,r),this.targetShape._handleEvent("mouseleave",e,r)),r._handleEvent("mouseover",e,this.targetShape),r._handleEvent("mouseenter",e,this.targetShape),this.targetShape=r))}else this.targetShape&&(!t||!t.moving)&&(this.targetShape._handleEvent("mouseout",e),this.targetShape._handleEvent("mouseleave",e),this.targetShape=null);t&&t._drag(e)},_mousedown:function(e){this._setUserPosition(e);var t=this.getIntersection(this.getUserPosition());if(t&&t.shape){var n=t.shape;this.clickStart=!0,n._handleEvent("mousedown",e)}Kinetic.DD&&this.attrs.draggable&&this._startDrag()},_mouseup:function(e){this._setUserPosition(e);var t=this,n=Kinetic.DD,r=this.getIntersection(this.getUserPosition());n&&n._endDrag(e);if(r&&r.shape){var i=r.shape;i._handleEvent("mouseup",e),this.clickStart&&(!n||!n.moving||!n.node)&&(i._handleEvent("click",e),this.inDoubleClickWindow&&i._handleEvent("dblclick",e),this.inDoubleClickWindow=!0,setTimeout(function(){t.inDoubleClickWindow=!1},this.dblClickWindow))}this.clickStart=!1},_touchstart:function(e){this._setUserPosition(e),e.preventDefault();var t=this.getIntersection(this.getUserPosition());if(t&&t.shape){var n=t.shape;this.tapStart=!0,n._handleEvent("touchstart",e)}Kinetic.DD&&this.attrs.draggable&&this._startDrag()},_touchend:function(e){this._setUserPosition(e);var t=this,n=Kinetic.DD,r=this.getIntersection(this.getUserPosition());n&&n._endDrag(e);if(r&&r.shape){var i=r.shape;i._handleEvent("touchend",e),this.tapStart&&(!n||!n.moving||!n.node)&&(i._handleEvent("tap",e),this.inDoubleClickWindow&&i._handleEvent("dbltap",e),this.inDoubleClickWindow=!0,setTimeout(function(){t.inDoubleClickWindow=!1},this.dblClickWindow))}this.tapStart=!1},_touchmove:function(e){this._setUserPosition(e);var t=Kinetic.DD;e.preventDefault();var n=this.getIntersection(this.getUserPosition());if(n&&n.shape){var r=n.shape;r._handleEvent("touchmove",e)}t&&t._drag(e)},_setMousePosition:function(e){var t=e.clientX-this._getContentPosition().left,n=e.clientY-this._getContentPosition().top;this.mousePos={x:t,y:n}},_setTouchPosition:function(e){if(e.touches!==undefined&&e.touches.length===1){var t=e.touches[0],n=t.clientX-this._getContentPosition().left,r=t.clientY-this._getContentPosition().top;this.touchPos={x:n,y:r}}},_getContentPosition:function(){var e=this.content.getBoundingClientRect();return{top:e.top,left:e.left}},_buildDOM:function(){this.content=document.createElement("div"),this.content.style.position="relative",this.content.style.display="inline-block",this.content.className="kineticjs-content",this.attrs.container.appendChild(this.content),this.bufferCanvas=new Kinetic.SceneCanvas,this.hitCanvas=new Kinetic.HitCanvas,this._resizeDOM()},_onContent:function(e,t){var n=e.split(" ");for(var r=0;r<n.length;r++){var i=n[r];this.content.addEventListener(i,t,!1)}},_setStageDefaultProperties:function(){this.nodeType="Stage",this.dblClickWindow=400,this.targetShape=null,this.mousePos=undefined,this.clickStart=!1,this.touchPos=undefined,this.tapStart=!1}},Kinetic.Global.extend(Kinetic.Stage,Kinetic.Container),Kinetic.Node.addGetters(Kinetic.Stage,["container"])})();
