(function(){function e(e){e.fillText(this.partialText,0,0)}function t(e){e.strokeText(this.partialText,0,0)}Kinetic.Text=function(e){this._initText(e)},Kinetic.Text.prototype={_initText:function(n){this.setDefaultAttrs({fontFamily:"Calibri",text:"",fontSize:12,align:"left",verticalAlign:"top",fontStyle:"normal",padding:0,width:"auto",height:"auto",lineHeight:1}),this.dummyCanvas=document.createElement("canvas"),Kinetic.Shape.call(this,n),this._fillFunc=e,this._strokeFunc=t,this.shapeType="Text",this._setDrawFuncs();var r=["fontFamily","fontSize","fontStyle","padding","align","lineHeight","text","width","height"],i=this;for(var s=0;s<r.length;s++){var o=r[s];this.on(o+"Change.kinetic",i._setTextData)}i._setTextData()},drawFunc:function(e){var t=e.getContext(),n=this.attrs.padding,r=this.attrs.lineHeight*this.getTextHeight(),i=this.textArr;t.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"px "+this.attrs.fontFamily,t.textBaseline="middle",t.textAlign="left",t.save(),t.translate(n,0),t.translate(0,n+this.getTextHeight()/2);for(var s=0;s<i.length;s++){var o=i[s];t.save(),this.attrs.align==="right"?t.translate(this.getWidth()-this._getTextSize(o).width-n*2,0):this.attrs.align==="center"&&t.translate((this.getWidth()-this._getTextSize(o).width-n*2)/2,0),this.partialText=o,e.fillStroke(this),t.restore(),t.translate(0,r)}t.restore()},drawHitFunc:function(e){var t=e.getContext(),n=this.getWidth(),r=this.getHeight();t.beginPath(),t.rect(0,0,n,r),t.closePath(),e.fillStroke(this)},setText:function(e){var t=Kinetic.Type._isString(e)?e:e.toString();this.setAttr("text",t)},getWidth:function(){return this.attrs.width==="auto"?this.getTextWidth()+this.attrs.padding*2:this.attrs.width},getHeight:function(){return this.attrs.height==="auto"?this.getTextHeight()*this.textArr.length*this.attrs.lineHeight+this.attrs.padding*2:this.attrs.height},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},_getTextSize:function(e){var t=this.dummyCanvas,n=t.getContext("2d");n.save(),n.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"px "+this.attrs.fontFamily;var r=n.measureText(e);return n.restore(),{width:r.width,height:parseInt(this.attrs.fontSize,10)}},_setTextData:function(){var e=this.attrs.text.split(""),t=[],n=0,r=!0;this.textWidth=0,this.textHeight=this._getTextSize(this.attrs.text).height;var i=this.attrs.lineHeight*this.textHeight;while(e.length>0&&r&&(this.attrs.height==="auto"||i*(n+1)<this.attrs.height-this.attrs.padding*2)){var s=0,o=undefined;r=!1;while(s<e.length){if(e.indexOf("\n")===s){e.splice(s,1),o=e.splice(0,s).join("");break}var u=e.slice(0,s);if(this.attrs.width!=="auto"&&this._getTextSize(u.join("")).width>this.attrs.width-this.attrs.padding*2){if(s==0)break;var a=u.lastIndexOf(" "),f=u.lastIndexOf("-"),l=Math.max(a,f);if(l>=0){o=e.splice(0,1+l).join("");break}o=e.splice(0,s).join("");break}s++,s===e.length&&(o=e.splice(0,s).join(""))}this.textWidth=Math.max(this.textWidth,this._getTextSize(o).width),o!==undefined&&(t.push(o),r=!0),n++}this.textArr=t}},Kinetic.Global.extend(Kinetic.Text,Kinetic.Shape),Kinetic.Node.addGettersSetters(Kinetic.Text,["fontFamily","fontSize","fontStyle","padding","align","lineHeight"]),Kinetic.Node.addGetters(Kinetic.Text,["text"])})();
